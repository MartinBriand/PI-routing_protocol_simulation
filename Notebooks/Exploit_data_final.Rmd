---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Import

```{python}
import pandas as pd
import pickle
import os

import numpy as np
import matplotlib.pyplot as plt
```

# Load data
## Loading

```{python}
auction_type = ['MultiLanes', 'SingleLane'][1]
node_auction_cost = 0.
terminaisons_file_name = [1, 2, 3]
```

```{python}
path = os.path.join(os.getcwd(), 'data/final/')

episodes_dfs = []
loads_dfs = []
movements_dfs = []
for terminaison in terminaisons_file_name:
    file_terminaison = auction_type + '_' + str(node_auction_cost) + '_' + str(terminaison) + '.bin'

    episodes_file_name = 'episodes_df_' + file_terminaison
    loads_file_name = 'loads_df_' + file_terminaison
    movements_file_name = 'movements_df_' + file_terminaison

    with open(os.path.join(path, episodes_file_name), 'rb') as f:
        episodes_df_t = pickle.load(f)
        episodes_df_t['terminaison'] = terminaison
        episodes_dfs.append(episodes_df_t)
    with open(os.path.join(path, loads_file_name), 'rb') as f:
        loads_df_t = pickle.load(f)
        loads_df_t['terminaison'] = terminaison
        loads_dfs.append(loads_df_t)
    with open(os.path.join(path, movements_file_name), 'rb') as f:
        movements_df_t = pickle.load(f)
        movements_df_t['terminaison'] = terminaison
        movements_dfs.append(movements_df_t)
        
episodes_df = pd.concat(episodes_dfs, axis=0)
loads_df = pd.concat(loads_dfs, axis=0)
movements_df = pd.concat(movements_dfs)

del episodes_file_name, loads_df_t, movements_df_t
        
episodes_df['name'] = episodes_df.name.apply(lambda x: x.split('_')[1]).astype('int64')
episodes_df.set_index(keys=['terminaison', 'run_id', 'home', 'name', 'episode_number'], inplace=True)
episodes_df.sort_index(inplace=True)
loads_df.set_index(keys=['terminaison', 'run_id', 'load_id'], inplace=True)
loads_df.sort_index(inplace=True)
movements_df.set_index(keys=['terminaison', 'run_id', 'load_id', 'step'], inplace=True)
movements_df.sort_index(inplace=True)
```

```{python}
path = os.path.join(os.getcwd(), '../PI_RPS/Games/data')
distances = pd.read_csv(os.path.join(path, 'city_distance_matrix_time_step.csv'), index_col=0)
```

## Preparing data

```{python}
episodes_df['distance'] = episodes_df.apply(lambda x: distances.loc[x.origin, x.destination], axis=1)
episodes_df['reserve_price_involved'] = episodes_df.reserve_price_involved.astype('bool')

episodes_df_filtered = episodes_df.loc[~episodes_df.reserve_price_involved].copy()

episodes_df_grouped = episodes_df.groupby(['terminaison', 'run_id', 'home', 'name'])
episodes_df_filtered_grouped = episodes_df_filtered.groupby(['terminaison', 'run_id', 'home', 'name'])

carriers_df = pd.concat([episodes_df_grouped[['t_c', 'ffh_c']].first(),
                         episodes_df_grouped[['revenue', 'cost']].sum()], 
                        axis=1)
carriers_df['cost_function'] = carriers_df.t_c + carriers_df.ffh_c
carriers_df['nb_reserve_price_involved'] = episodes_df.reserve_price_involved.astype('int64').groupby(['terminaison', 'run_id', 'home', 'name']).sum()
carriers_df['nb_reserve_price_involved'].fillna(-1, inplace=True)
carriers_df['nb_reserve_price_involved'] = carriers_df['nb_reserve_price_involved'].astype('int64')

carriers_df_filtered = pd.concat([episodes_df_filtered_grouped[['t_c', 'ffh_c']].first(),
                                  episodes_df_filtered_grouped[['revenue', 'cost']].sum()], 
                        axis=1)
carriers_df_filtered['cost_function'] = carriers_df.t_c + carriers_df.ffh_c

loads_df['direct_distance'] = loads_df.apply(lambda x: distances.loc[x.departure, x.arrival], axis=1)
movements_df['distance'] = movements_df.apply(lambda x: distances.loc[x.origin, x.destination], axis=1)

movements_df['carrier_home'] = movements_df.carrier.apply(lambda x: x.split('_')[0])
movements_df['carrier_name'] = movements_df.carrier.apply(lambda x: x.split('_')[1]).astype('int64')

movements_df_filtered = movements_df.loc[~movements_df.reserve_price_involved].copy()

movements_df_grouped = movements_df.groupby(['terminaison', 'run_id', 'load_id'])

loads_df['route'] = movements_df_grouped['destination'].agg(list).apply(lambda x: '-'.join(x))
loads_df['route'] = loads_df.departure + '-' + loads_df.route

loads_df['nb_hops'] = movements_df_grouped.count().origin.rename('nb_hops')
loads_df['nb_hops'].fillna(-1, inplace=True)
loads_df['nb_hops'] = loads_df['nb_hops'].astype('int64')

loads_df['total_distance'] = movements_df_grouped['distance'].sum()
loads_df['total_distance'].fillna(-1, inplace=True)
loads_df['total_distance'] = loads_df['total_distance'].astype('int64')

loads_df['total_price'] = movements_df_grouped['price'].sum()

loads_df['nb_reserve_price_involved'] = movements_df.reserve_price_involved.astype('int64').groupby(['terminaison', 'run_id', 'load_id']).sum()
loads_df['nb_reserve_price_involved'].fillna(-1, inplace=True)
loads_df['nb_reserve_price_involved'] = loads_df['nb_reserve_price_involved'].astype('int64')

loads_df_filtered = loads_df.loc[(loads_df.nb_reserve_price_involved == 0) & (loads_df.direct_distance <= loads_df.total_distance)].copy()
```

# Analysis
## Sanity check for involvement of reserve price
We want lower than 1%

```{python}
rp_i_origin = movements_df.loc[:, ['origin', 'reserve_price_involved', 'destination']].pivot_table(values='destination', index='origin', columns='reserve_price_involved', aggfunc='count')
rp_i_origin['perc'] = rp_i_origin[True] / (rp_i_origin[True] + rp_i_origin[False])
rp_involved_in_mvmts_count = movements_df.groupby('reserve_price_involved').count()
perc_rp_involved_in_mvmts = rp_involved_in_mvmts_count.loc[True, 'origin'] / rp_involved_in_mvmts_count.origin.sum()
print("Reserve price is involved in {}% of the movements".format(round(perc_rp_involved_in_mvmts*100, 3)))

rp_involved_in_loads = 1-(loads_df_filtered.departure.count() / loads_df.loc[(loads_df.nb_reserve_price_involved >= 0) & (loads_df.direct_distance <= loads_df.total_distance)].departure.count())
print("Reserve price is involved in {}% of the loads".format(round(rp_involved_in_loads*100, 3)))

print(rp_i_origin)
```

## Carriers
### Concentration at nodes

```{python}
origin_of_carriers = carriers_df.loc[(slice(None), 0, slice(None))].groupby(['terminaison', 'home']).count()['t_c'].rename('nb_carriers').to_frame().reset_index().pivot(index='home', columns='terminaison', values='nb_carriers')

carriers_concentration = episodes_df.groupby('origin')['type'].count()
carriers_concentration_prop = carriers_concentration / carriers_concentration.sum()
carriers_concentration_origin = episodes_df.pivot_table(index='origin', columns='home', values='type', aggfunc='count', fill_value=0)
carriers_concentration_origin_prop = carriers_concentration_origin / carriers_concentration_origin.sum(axis=1)

print(origin_of_carriers)
print(carriers_concentration_prop)
print(carriers_concentration_origin_prop)
```

### Profit and who operate
#### Tables

```{python}
carriers_df_filtered['profit'] = carriers_df_filtered.revenue - carriers_df_filtered.cost
carriers_df_filtered['nb_ops'] = episodes_df_filtered.groupby(['terminaison', 'run_id', 'home', 'name'])['cost'].count().fillna(0).astype('int64')
carriers_df_filtered['nb_ops'] = carriers_df_filtered['nb_ops'].fillna(0).astype('int64')
carriers_df_filtered['nb_transport_ops'] = episodes_df_filtered.loc[episodes_df_filtered.type == 'Transport'].groupby(['terminaison', 'run_id', 'home', 'name'])['cost'].count()
carriers_df_filtered['nb_transport_ops'] = carriers_df_filtered['nb_transport_ops'].fillna(0).astype('int64')


profit_home_filtered = (carriers_df_filtered/500).groupby('home')['profit'].describe()
transport_operations_home_filtered = carriers_df_filtered.groupby('home')['nb_transport_ops'].describe()

carriers_df['profit'] = carriers_df.revenue - carriers_df.cost
carriers_df['nb_ops'] = episodes_df.groupby(['terminaison', 'run_id', 'home', 'name'])['cost'].count().fillna(0).astype('int64')
carriers_df['nb_ops'] = carriers_df['nb_ops'].fillna(0).astype('int64')
carriers_df['nb_transport_ops'] = episodes_df.loc[episodes_df.type == 'Transport'].groupby(['terminaison', 'run_id', 'home', 'name'])['cost'].count()
carriers_df['nb_transport_ops'] = carriers_df['nb_transport_ops'].fillna(0).astype('int64')


profit_home = (carriers_df/500).groupby('home')['profit'].describe()
transport_operations_home = carriers_df.groupby('home')['nb_transport_ops'].describe()

print((carriers_df_filtered['profit']/500).describe())

print(profit_home_filtered)

print(carriers_df_filtered['nb_transport_ops'].describe())

print(transport_operations_home_filtered)
```

```{python}
carriers_df_filtered_to_plot = carriers_df_filtered.groupby(['terminaison', 'home', 'name'])[['cost_function', 'profit', 'nb_transport_ops']].mean()
def plot_nodes(nodes):
    carriers_df_filtered_to_plot_node = carriers_df_filtered_to_plot.loc[(slice(None), nodes, slice(None))] \
        if nodes is not None else carriers_df_filtered_to_plot
    x = carriers_df_filtered_to_plot_node.cost_function.to_numpy()
    y_profit = carriers_df_filtered_to_plot_node.profit.to_numpy()
    y_nb_ops = carriers_df_filtered_to_plot_node.nb_transport_ops.to_numpy()
    x_div = x[y_nb_ops > 0]
    y_div = y_profit[y_nb_ops > 0] / y_nb_ops[y_nb_ops > 0]
    x_div, y_div = x_div[y_div > 0], y_div[y_div > 0]

    fig, axes = plt.subplots(nrows=1, ncols=3, figsize = (12, 4.8))
    axes[0].scatter(x=x, y=y_profit)
    axes[0].set_title('Profit')
    axes[1].scatter(x=x, y=y_nb_ops)
    axes[1].set_title('Number of operations')
    axes[2].scatter(x=x_div, y=y_div)
    axes[2].set_title('Profit per operation')
    title = ', '.join(nodes) if nodes else 'All'
    fig.suptitle(title)
    return fig

figs = []
filters = [None, ['Bremen'], ['Dresden'], ['Madrid'], ['Marseille'], ['Milan'], ['Naples'], ['Paris'], ['Rotterdam'], ['Saarbrücken'], ['Salzburg'], ['Warsaw']]
for fil in filters:
    figs.append(plot_nodes(fil))
```

## Loads

```{python}
# not filtered
price_per_total_distance = loads_df.groupby('total_distance')['total_price'].agg(['mean', 'count']).rename({'mean': 'total_price', 'count': 'nb_info'}, axis=1).reset_index()
price_per_total_distance['price_per_distance'] = price_per_total_distance.total_price / price_per_total_distance.total_distance

#filtered
price_per_direct_distance = loads_df_filtered.groupby('direct_distance')['total_price'].agg(['mean', 'count']).rename({'mean': 'total_price', 'count': 'nb_info'}, axis=1).reset_index()
price_per_direct_distance['price_per_distance'] = price_per_direct_distance.total_price / price_per_direct_distance.direct_distance

print(price_per_total_distance)
print(price_per_direct_distance)
```

```{python}
nb_hops_per_direct_distance = loads_df_filtered.groupby('direct_distance')['nb_hops'].describe()

print(nb_hops_per_direct_distance)
```

Looks like it works well in doing the routing

```{python}
most_used_routes = loads_df_filtered.groupby('route')['total_price'].agg(['count', 'mean']).sort_values(by='count', ascending=False).rename({'mean': 'mean_price'}, axis=1)
most_used_complex_routes = loads_df_filtered.loc[loads_df_filtered.nb_hops > 1].groupby('route')['total_price'].agg(['count', 'mean']).sort_values(by='count', ascending=False).rename({'mean': 'mean_price'}, axis=1)
perce_complex_routes = most_used_complex_routes['count'].sum() / most_used_routes['count'].sum()

print("{} % of the routes are complex routes".format(round(perce_complex_routes*100, 1)))
```

```{python}
price_per_departure_destination = loads_df_filtered.groupby(['departure', 'arrival'])['total_price'].describe()
hops_per_departure_destination = loads_df_filtered.groupby(['departure', 'arrival'])['nb_hops'].describe()

print(price_per_departure_destination)
print(hops_per_departure_destination)
```

```{python}
model_path = '/mnt/c/Users/marti/OneDrive/Documents/Praktikum KLU/Models/od_prices/'
loads_df_filtered.groupby(['departure', 'arrival'])[['total_price']].mean().reset_index().pivot(index='departure', columns='arrival', values='total_price'
                                                                                               ).to_excel(model_path +
                                                                                                          'od_prices_' +
                                                                                                          auction_type + '_' +
                                                                                                          str(node_auction_cost) + '.xlsx')
```

```{python}
loads_df_filtered.total_price.describe()
```

```{python}
print('Empty distance', episodes_df.loc[episodes_df.type == 'Empty'].distance.sum() / (episodes_df.loc[episodes_df.type == 'Transport'].distance.sum() + episodes_df.loc[episodes_df.type == 'Empty'].distance.sum()))
print('Empty travel', episodes_df.loc[episodes_df.type == 'Empty'].distance.count() / (episodes_df.loc[episodes_df.type == 'Transport'].distance.count() + episodes_df.loc[episodes_df.type == 'Empty'].distance.count()))
```

```{python}

```
