---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Import

```{python}
import pandas as pd
import pickle
import os

import numpy as np
import matplotlib.pyplot as plt
```

# Load data
## Loading

```{python}
n_carriers_per_node = 30
node_auction_cost = 0.
auction_type = ['MultiLanes', 'SingleLane'][1]
```

```{python}
path = os.path.join(os.getcwd(), 'data')

episodes_file_name = 'episodes_df_' + auction_type + '_' + str(node_auction_cost) + '_' + str(n_carriers_per_node) + '.bin'
loads_file_name = 'loads_df_' + auction_type + '_' + str(node_auction_cost) + '_' + str(n_carriers_per_node) + '.bin'
movements_file_name = 'movements_df_' + auction_type + '_' + str(node_auction_cost) + '_' + str(n_carriers_per_node) + '.bin'

with open(os.path.join(path, episodes_file_name), 'rb') as f:
    episodes_df = pickle.load(f)
with open(os.path.join(path, loads_file_name), 'rb') as f:
    loads_df = pickle.load(f)
with open(os.path.join(path, movements_file_name), 'rb') as f:
    movements_df = pickle.load(f)
    
episodes_df['name'] = episodes_df.name.apply(lambda x: x.split('_')[1]).astype('int64')
episodes_df.set_index(keys=['run_id', 'home', 'name', 'episode_number'], inplace=True)
episodes_df.sort_index(inplace=True)
loads_df.set_index(keys=['run_id', 'load_id'], inplace=True)
loads_df.sort_index(inplace=True)
movements_df.set_index(keys=['run_id', 'load_id', 'step'], inplace=True)
movements_df.sort_index(inplace=True)
```

```{python}
path = os.path.join(os.getcwd(), '../PI_RPS/Games/data')
distances = pd.read_csv(os.path.join(path, 'city_distance_matrix_time_step.csv'), index_col=0)
```

## Preparing data

```{python}
episodes_df['reserve_price_involved'] = episodes_df.revenue >= 10000

episodes_df_filtered = episodes_df.loc[~episodes_df.reserve_price_involved].copy()

episodes_df_grouped = episodes_df.groupby(['run_id', 'home', 'name'])

carriers_df = pd.concat([episodes_df_grouped[['t_c', 'ffh_c']].first(),
                         episodes_df_grouped[['revenue', 'cost']].sum()], 
                        axis=1)
carriers_df['cost_function'] = carriers_df.t_c + carriers_df.ffh_c
carriers_df['nb_reserve_price_involved'] = episodes_df.reserve_price_involved.astype('int64').groupby(['run_id', 'home', 'name']).sum()
carriers_df['nb_reserve_price_involved'].fillna(-1, inplace=True)
carriers_df['nb_reserve_price_involved'] = carriers_df['nb_reserve_price_involved'].astype('int64')

carriers_df_filtered = carriers_df.loc[carriers_df.nb_reserve_price_involved == 0].copy()

loads_df['direct_distance'] = loads_df.apply(lambda x: distances.loc[x.departure, x.arrival], axis=1)
movements_df['distance'] = movements_df.apply(lambda x: distances.loc[x.origin, x.destination], axis=1)

movements_df['carrier_home'] = movements_df.carrier.apply(lambda x: x.split('_')[0])
movements_df['carrier_name'] = movements_df.carrier.apply(lambda x: x.split('_')[1]).astype('int64')

movements_df_filtered = movements_df.loc[~movements_df.reserve_price_involved].copy()

movements_df_grouped = movements_df.groupby(['run_id', 'load_id'])

loads_df['route'] = movements_df_grouped['destination'].agg(list).apply(lambda x: '-'.join(x))
loads_df['route'] = loads_df.departure + '-' + loads_df.route

loads_df['nb_hops'] = movements_df_grouped.count().origin.rename('nb_hops')
loads_df['nb_hops'].fillna(-1, inplace=True)
loads_df['nb_hops'] = loads_df['nb_hops'].astype('int64')

loads_df['total_distance'] = movements_df_grouped['distance'].sum()
loads_df['total_distance'].fillna(-1, inplace=True)
loads_df['total_distance'] = loads_df['total_distance'].astype('int64')

loads_df['total_price'] = movements_df_grouped['price'].sum()

loads_df['nb_reserve_price_involved'] = movements_df.reserve_price_involved.astype('int64').groupby(['run_id', 'load_id']).sum()
loads_df['nb_reserve_price_involved'].fillna(-1, inplace=True)
loads_df['nb_reserve_price_involved'] = loads_df['nb_reserve_price_involved'].astype('int64')

loads_df_filtered = loads_df.loc[(loads_df.nb_reserve_price_involved == 0) & (loads_df.direct_distance <= loads_df.total_distance)].copy()
```

# Analysis
## Sanity check for involvement of reserve price
We want lower than 0.5%

```{python}
rp_involved_in_mvmts_count = movements_df.groupby('reserve_price_involved').count()
perc_rp_involved_in_mvmts = rp_involved_in_mvmts_count.loc[True, 'origin'] / rp_involved_in_mvmts_count.origin.sum()
print("Reserve price is involved in {}% of the movements".format(round(perc_rp_involved_in_mvmts*100, 1)))

rp_involved_in_loads = 1-(loads_df_filtered.departure.count() / loads_df.loc[(loads_df.nb_reserve_price_involved >= 0) & (loads_df.direct_distance <= loads_df.total_distance)].departure.count())
print("Reserve price is involved in {}% of the loads".format(round(rp_involved_in_loads*100, 1)))
```

## Carriers
### Concentration at nodes

```{python}
nb_carriers = carriers_df['t_c'].count()
carriers_concentration = episodes_df.groupby('origin')['type'].count()
carriers_concentration_prop = carriers_concentration / carriers_concentration.sum()
carriers_concentration_origin = episodes_df.pivot_table(index='origin', columns='home', values='type', aggfunc='count', fill_value=0)
carriers_concentration_origin_prop = carriers_concentration_origin / carriers_concentration_origin.sum(axis=1)

print(carriers_concentration_prop)
print(carriers_concentration_origin_prop)
```

I am not sure whether or not there are a lot of things to understand from this, just that extreme nodes tend to keep their carriers at home while it is easier for the other to have carriers waiting abroad.

I would expect that extreme nodes can make less profit because of less operations


### Profit and who operate
#### Tables

```{python}
carrier_index = carriers_df.index
general_operations = pd.DataFrame(index=carrier_index)
```

```{python}
carriers_df_filtered[['transport_revenue', 'transport_cost']] = episodes_df_filtered.loc[episodes_df_filtered.type == 'Transport'].groupby(['run_id', 'home', 'name'])[['revenue', 'cost']].sum()
carriers_df_filtered[['movement_revenue', 'movement_cost']] = episodes_df_filtered.loc[episodes_df_filtered.type != 'Wait'].groupby(['run_id', 'home', 'name'])[['revenue', 'cost']].sum()
carriers_df_filtered['profit'] = carriers_df_filtered.revenue - carriers_df_filtered.cost
carriers_df_filtered['transport_profit'] = carriers_df_filtered.transport_revenue - carriers_df_filtered.transport_cost
carriers_df_filtered['movement_profit'] = carriers_df_filtered.movement_revenue - carriers_df_filtered.movement_cost
carriers_df_filtered['nb_ops'] = episodes_df_filtered.groupby(['run_id', 'home', 'name'])['cost'].count().fillna(0).astype('int64')
carriers_df_filtered['nb_ops'] = carriers_df_filtered['nb_ops'].fillna(0).astype('int64')
carriers_df_filtered['nb_transport_ops'] = episodes_df_filtered.loc[episodes_df_filtered.type == 'Transport'].groupby(['run_id', 'home', 'name'])['cost'].count()
carriers_df_filtered['nb_transport_ops'] = carriers_df_filtered['nb_transport_ops'].fillna(0).astype('int64')
carriers_df_filtered['nb_movement_ops'] = episodes_df_filtered.loc[episodes_df_filtered.type != 'Wait'].groupby(['run_id', 'home', 'name'])['cost'].count()
carriers_df_filtered['nb_movement_ops'] = carriers_df_filtered['nb_movement_ops'].fillna(0).astype('int64')


movement_profit_home = (carriers_df_filtered/500).groupby('home')['movement_profit'].describe()
operations_home = carriers_df_filtered.groupby('home')['nb_movement_ops'].describe()

print((carriers_df_filtered['movement_profit']/500).describe())
print(movement_profit_home)
print(carriers_df_filtered['nb_movement_ops'].describe())
print(operations_home)
```

```{python}
x = carriers_df_filtered.cost_function.to_numpy()
y_profit = carriers_df_filtered.movement_profit.to_numpy()
y_nb_ops = carriers_df_filtered.nb_movement_ops.to_numpy()

fig, axes = plt.subplots(nrows=1, ncols=2)
axes[0].scatter(x=x, y=y_profit)
axes[0].set_title('Profit')
axes[1].scatter(x=x, y=y_nb_ops)
axes[1].set_title('Nb_ops')
```

## Loads

```{python}
price_per_total_distance = loads_df_filtered.groupby('total_distance')['total_price'].agg(['mean', 'count']).rename({'mean': 'total_price', 'count': 'nb_info'}, axis=1).reset_index()
price_per_total_distance['price_per_distance'] = price_per_total_distance.total_price / price_per_total_distance.total_distance

price_per_direct_distance = loads_df_filtered.groupby('direct_distance')['total_price'].agg(['mean', 'count']).rename({'mean': 'total_price', 'count': 'nb_info'}, axis=1).reset_index()
price_per_direct_distance['price_per_distance'] = price_per_direct_distance.total_price / price_per_direct_distance.direct_distance

print(price_per_total_distance)
print(price_per_direct_distance)
```

We see that price per total distance can be very low, this is because of loads being on trucks going home for almost free (see (3,312)).

However, the price per direct distance goes down but not much This is because they have more oportunities to take advantage of the previously described phenomenon (see (4,1984)).

```{python}
nb_hops_per_direct_distance = loads_df_filtered.groupby('direct_distance')['nb_hops'].describe()

print(nb_hops_per_direct_distance)
```

Looks like it works well in doing the routing

```{python}
most_used_routes = loads_df_filtered.groupby('route')['total_price'].agg(['count', 'mean']).sort_values(by='count', ascending=False).rename({'mean': 'mean_price'}, axis=1)
most_used_complex_routes = loads_df_filtered.loc[loads_df_filtered.nb_hops > 1].groupby('route')['total_price'].agg(['count', 'mean']).sort_values(by='count', ascending=False).rename({'mean': 'mean_price'}, axis=1)
perce_complex_routes = most_used_complex_routes['count'].sum() / most_used_routes['count'].sum()

print("{} % of the routes are complex routes".format(round(perce_complex_routes*100, 1)))
```

```{python}
price_per_departure_destination = loads_df_filtered.groupby(['departure', 'arrival'])['total_price'].describe()
hops_per_departure_destination = loads_df_filtered.groupby(['departure', 'arrival'])['nb_hops'].describe()

print(price_per_departure_destination)
print(hops_per_departure_destination)
```

```{python}
model_path = '/mnt/c/Users/marti/OneDrive/Documents/Praktikum KLU/Models/od_prices/'
loads_df_filtered.groupby(['departure', 'arrival'])[['total_price']].mean().reset_index().pivot(index='departure', columns='arrival', values='total_price'
                                                                                               ).to_excel(model_path +
                                                                                                          'od_prices_' +
                                                                                                          auction_type + '_' +
                                                                                                          str(node_auction_cost) + '_' +
                                                                                                          str(n_carriers_per_node) + '.xlsx')
```

```{python}
loads_df_filtered.total_price.describe()
```

```{python}

```
