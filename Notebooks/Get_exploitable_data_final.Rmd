---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

# Imports

```{python}
# Libraries
import pandas as pd
import os
import time 
import pickle

# Tools
from PI_RPS.Games.init_tools import load_learned_games
```

```{python tags=c()}
auction_type = ['MultiLanes', 'SingleLane'][1]
node_auction_cost = 250.
terminaison_file_name = 3
file_name = auction_type + '_' + str(node_auction_cost) + '_' + str(terminaison_file_name) + '.bin'
```

<!-- #region tags=[] -->
# Loop
## Runners and data getters
<!-- #endregion -->

```{python}
episodes_cols = ['run_id', 'name', 'home', 'episode_number', 't_c', 'ffh_c', 'type', 'origin', 'destination', 'reserve_price_involved', 'revenue', 'cost']
loads_cols = ['run_id', 'load_id', 'departure', 'arrival', 'is_arrived', 'is_discarded', 'in_transit']
movements_cols = ['run_id', 'load_id', 'step', 'origin', 'destination', 'carrier', 'price', 'reserve_price_involved']
episodes_df = pd.DataFrame(columns=episodes_cols)
loads_df = pd.DataFrame(columns=loads_cols)
movements_df = pd.DataFrame(columns=movements_cols)
```

```{python}
def run(e, nb_iter_per_run, run_number):
    # Running environment
    for _ in range(nb_iter_per_run):
        e.iteration()

    # Getting data
    episodes_data = []
    for carrier_p in e.carriers:
        episode_types = carrier_p.episode_types
        episode_revenues = carrier_p.episode_revenues
        episode_expenses = carrier_p.episode_expenses
        for episode_k in range(len(episode_types)):
            episodes_data.append([run_number,
                                  carrier_p.name,
                                  carrier_p.home.name,
                                  episode_k,
                                  carrier_p.t_c,
                                  carrier_p.ffh_c,
                                  episode_types[episode_k][0],
                                  episode_types[episode_k][1].name,
                                  episode_types[episode_k][2].name,
                                  episode_types[episode_k][3],
                                  episode_revenues[episode_k],
                                  episode_expenses[episode_k]
                                 ])
            
    new_episodes_df = pd.DataFrame(columns=episodes_cols, data=episodes_data)
    
    loads_data = []
    movements_data = []
    loads = e.loads
    for load_p_k in range(len(loads)):
        load_p = loads[load_p_k]
        movements = load_p.movements
        loads_data.append([run_number,
                           load_p_k,
                           load_p.departure.name,
                           load_p.arrival.name,
                           load_p.is_arrived,
                           load_p.is_discarded,
                           load_p.in_transit
                          ])
        
        for step_k in range(len(movements)):
            movement = movements[step_k]
            movements_data.append([run_number,
                               load_p_k,
                               step_k,
                               movement[0].name,
                               movement[1].name,
                               movement[2].name,
                               movement[3] + movement[4],
                               movement[5]  # this sould be the involvment of reserve price in the movement
                              ])
            
    
    
    new_loads_df = pd.DataFrame(columns=loads_cols, data=loads_data)
    new_movements_df = pd.DataFrame(columns=movements_cols, data=movements_data)
    return new_episodes_df, new_loads_df, new_movements_df
```

## Actual loop

```{python}
nb_loop = 10
nb_iteration_per_run = 500
start_time = time.time()

for k in range(nb_loop):
    e = load_learned_games(file_name)
    new_episodes_df, new_loads_df, new_movements_df = run(e=e,
                                                          nb_iter_per_run=nb_iteration_per_run,
                                                          run_number=k)
    
    episodes_df = pd.concat(objs=[episodes_df, new_episodes_df], ignore_index=True)
    loads_df = pd.concat(objs=[loads_df, new_loads_df], ignore_index=True)
    movements_df = pd.concat(objs=[movements_df, new_movements_df], ignore_index=True)
    
movements_df['reserve_price_involved'] = movements_df.reserve_price_involved.astype(bool)

end_time = time.time()
delta = int(end_time - start_time)
delta_h = delta // 3600
delta_m = (delta % 3600) // 60
delta_s = (delta % 3600) % 60
print("Total time:", "{}h{}m{}s".format(delta_h, delta_m, delta_s))
```

# Export results

```{python}
path = os.path.join(os.getcwd(), 'data/final')
# file_terminaison = auction_type + '_' + str(node_auction_cost) + '_' + str(n_carriers_per_node) + '_' + str(cost_majoration) + '.bin'
file_terminaison = auction_type + '_' + str(node_auction_cost) + '_' + str(terminaison_file_name) + '.bin'
episodes_file_name = 'episodes_df_' + file_terminaison
loads_file_name = 'loads_df_' + file_terminaison
movements_file_name = 'movements_df_' + file_terminaison
with open(os.path.join(path, episodes_file_name), 'wb') as f:
    pickle.dump(episodes_df, f)
with open(os.path.join(path, loads_file_name), 'wb') as f:
    pickle.dump(loads_df, f)
with open(os.path.join(path, movements_file_name), 'wb') as f:
    pickle.dump(movements_df, f)
```

```{python}

```
